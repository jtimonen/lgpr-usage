---
title: "Comparing Gaussian process and linear models for longitudinal data"
author: "Juho Timonen"
date: "`r Sys.Date()`"
bibliography: references.bib
output: 
  rmarkdown::html_vignette:
    toc: true
#  pdf_document:
#    toc: true     
vignette: >
  %\VignetteIndexEntry{Comparing Gaussian process and linear models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "##"
)
```

This vignette demonstrates how to use the `lgp` function of the **lgpr** package as an alternative for the the linear mixed effect model fitting function `lmer` of the **lme4** package @bates2015.

```{r load}
require(lgpr)
require(lme4)
require(lmerTest)
require(ggplot2)
```


## Data simulation
We use `lgpr` to simulate data with nonlinear effects.
```{r sim, fig.width=7, fig.height=5.5}
set.seed(1323)
simData <- simulate_data(N            = 16,
                         t_data       = c(12,24,36,48,60),
                         covariates   = c(2,2,2),
                         relevances   = c(1,1,1,0,0),
                         snr          = 5,
                         lengthscales = c(12,24,12,12,12),
                         t_jitter     = 0.5)
data <- simData$data

# print crosstabulation
xt <- xtabs(~ z1+z2+z3, data)
print(xt)

# plot data
plot_simdata(simData, componentwise = F)
plot_simdata(simData, componentwise = T)
print(head(data))
```

## Linear mixed effect modeling using lme4
We use the **lmerTest** package by @kuznetsova2017 to fit and study a linear mixed effects model. It uses the `lmer` function of the **lme4** package by @bates2015 to fit the model, but extends **lme4** with more comprehensive model selection and assessment methods. 

```{r lme4_1, fig.width=7, fig.height=4.5}
fit <- lmerTest::lmer(y ~ 1 + id + (age|id) 
                      + z1 + z2 + z3,
                      data = data)
summary(fit)

fe <- drop1(fit)
print(fe)
pval <- fe$`Pr(>F)`
print(pval)
```

We could also do backward model selection.
```{r lme4_step, fig.width=7, fig.height=4.5}
#bs <- lmerTest::step(fit)
#print(bs)
```


## Additive GP modeling using lgpr
Then, we fit an additive GP model using **lgpr**.
```{r lgpr, fig.width=7, fig.height=4.5}
fit_lgp <- lgp(y ~ id + age + z1 + z2 + z3, 
                  data    = data,
                  iter    = 1000, 
                  chains  = 1,
                  refresh = 0)
plot(fit_lgp)
plot_components(fit_lgp)
```

## References
